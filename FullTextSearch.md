全文搜索引擎
===

首先，为什么需要一个专门的全文搜索引擎：

搜医搜项目的定位是在医疗领域的垂直搜索，因此数据量非常大，目前数据库里包含13万条体检信息、45万条医生信息、6万条医院药店信息，信息量已经不小了，但对于一个定位在垂直搜索的项目来说还有些不足，我们需要更多的数据。

但是数据增长带来的问题就是数据间如何关联、如何被检索到：

数据量少的情况下，我们可以简单的使用SQL数据库LIKE语句 `LIKE %关键字%` 进行搜索，但数据量较大的情况下是行不通的，例如，目前的运行环境下，搜索某个疾病相关的医生，需要对医生表简介字段 `doctors.desc` 进行LIKE检索。

```
  Hospitals::Doctor Load (15317.9ms)  SELECT `doctors`.* FROM `doctors`  WHERE (`doctors`.`desc` LIKE '%冠心病%')
```

耗时15秒，这已经是没法接受的时间了，因此目前做法是事先搜索好医生和疾病的对应关系，建立一个医生和疾病的关联表储存，并定时更新，这样效率上可以接受，但又存在一些其他问题，例如无法模糊搜索（根据部分关键字命中），只能搜索到数据库中存在的疾病对应的医生，如果数据库里没有医生简介里提及的疾病，则无法搜索到疾病对应的医生。

这时候就需要全文检索引擎来处理这类问题了

全文检索引擎，本身可以视为一个数据库，但通常作为数据库性能较差，所以会搭配数据库使用，它会对输入的文本进行分词，每次检索时检索分词结果，而不是文本本身，分词结果都带有索引，因此搜索速度会比数据库使用 `%` 快很多，以前的项目做过实验，在200万条数据左右，使用一个C语言实现的全文搜索引擎 `Sphinx` ，速度上比MySQL直接使用LIKE语句进行搜索快近200倍，数据越多，两者性能差距越大。

主流全文搜索引擎
---

以前实验室的项目接触过一些全文检索引擎，海量数据挖掘方面的内容，尝试过以下集中全文检索引擎，大致说下感受：

### Sphinx
基于C++开发，软件本身很小，可以跟MySQL数据库无缝结合（这点我没有亲自尝试过，之前数据库用MongoDB），据说效率在全文检索引擎里是最快的，我理解它之所以快是它的索引结构，Sphinx建立的索引文件是不能动态修改的，即，在Sphinx运行过程中，没有办法向现有的索引库添加新索引，所以官方给出的解决方案是建立增量索引，也就是说，有一份主索引保存大量数据，一份增量索引，在每次有新数据入库时重建新数据（主索引包含数据以外的这部分数据）的索引。

优势：

1. 基于 C++，高效快速，运行稳定
2. 建立索引速度 Lucene 望尘莫及，比 Lucene 快 5-10 倍；搜索速度快于 Lucene；
3. 对数据库的支持全面完善，还可以直接作为 MySQL 的存储引擎；
4. 无需二次开发，即可直接使用；
5. 拥有丰富的全文查询语法。

不足:

1. 索引的数据都需要有一个唯一整数编号；
2. 无法像Lucene快速嵌入其他应用内部，需要作为服务运行，通过接口调用； 
3. 分布式搜索没有Lucene完善和强大，需要人工进行数据的切分；
4. 索引数据中的文档内容不能及时更新，且不能保留原始文本内容；最新测试版本支持，但尚处于测试阶段。

之前项目最终决定使用这个搜索引擎，所以对它最熟悉。

### Lucene / Solr
这个是Apache基金会的开源项目，Java编写，使用最方便，提供的功能也最全面，甚至包含一个类似百度的搜索界面，和后台管理页面，支持在动态添加索引。

优势：

1. 基于 Java 开发，方便二次开发。
2. 用户较多，第三方支持最完善。
3. 支持动态添加索引，因此可以适应数据频繁变化的索引业务（但我觉着咱的数据基本不会有变化，增删也不会太频繁？）

不足：

1. 搜索不如 Sphinx 快，应该是因为建立索引的方式导致的。
2. 内存用量很惊人。

### ElasticSearch
相对较新的搜索引擎，没试用过，不过文档看起来还不错，有需要就预研下

### pg_search
PostgreSQL内嵌的全文搜索工具，跟其他几个搜索引擎不同的是，pg_search本身内嵌在数据库里，所以使用起来最为方便，和Rails搭配起来开发很省事儿，不过对于咱的项目来说，需要数据迁移到PostgreSQL上去。
不过近几年PostgreSQL发展很迅速，在国外用的很多，国内倒是刚起步，据说从 v8.0 开始性能就已经超过了 MySQL ，不过也可能只是自吹自擂，目前版本到 v9.4 。

Rails社区比较鼓励用PostgreSQL，因为PostgreSQL有不少很吸引人的新特性，对Rails应用来说，PostgreSQL是最友好的。
